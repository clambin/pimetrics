stages:
  - test
  - release
#  - freeze

.test_only:
  only:
    changes:
      - "pimetrics/*.py"
      - "tests/*.py"
  except:
    - tags

.build_only:
  only:
    changes:
      - "*.py"
      - "pimetrics/*.py"
      - .gitlab-ci.yml
  except:
    - tags


flake8:
  stage: test
  extends: .test_only
  image: python:3.7
  before_script:
    - pip install pipenv
    - pipenv install --dev
  script:
    - pipenv run flake8 --max-line-length 120 pimetric/*.py

pytest:
  stage: test
  extends: .test_only
  image: python:3.7
  before_script:
    - pip install pipenv
    - pipenv install --dev
  script:
    - pipenv check
    - cd tests && pipenv run pytest --cov
    - pipenv run bash <(curl -s https://codecov.io/bash) -s tests

pypi:
  stage: release
  image: python:3.7
  only:
    refs:
      - master
  before_script:
    - pip install -U twine
    - echo "[pypi]" > ~/.pypirc
    - echo "    username = __token__" >> ~/.pypirc
    - echo "    password = ${TWINE_PASSWORD}" >> ~/.pypirc
  script:
    - python setup.py check sdist bdist  # This will fail if your creds are bad.
    - python setup.py sdist bdist_wheel
    - twine upload dist/*

#github:
#  stage: freeze
#  only:
#    refs:
#      - master
#  before_script:
#    - export TAG=$(grep -i ^version pimetrics/version.py | awk '{ print $3 }' | tr -d \');
#  script:
#    - git remote set-url origin "https://$GITHUB_USER:$GITHUB_TOKEN@github.com/$CI_PROJECT_PATH.git"
#    - git tag $TAG
#    - git push --tags